/*
Rule Transition Plugin v1.0.0
Includes:
# forked: forked from: Universal Transition - http://jsdo.it/nosemint/9OWJ
Licensed under the MIT license - http://opensource.org/licenses/MIT
*/
(function($,TYRANO,object){if(typeof TYRANO.kag.ftag.master_tag['bg_rule']!=='undefined'){return}var tag={};tag['bg_rule']={pm:{'storage':'xxx.jpg','color':'','rule':'xxx.png','time':'1000','wait':'true','clickskip':'false','reverse':'false'},start:function(pm){mainCanvas=document.getElementById('canvas_bg_rule');mainCanvas.ctx=mainCanvas.getContext('2d');if(isTrans){finishTransition()}var nextImageSrc=parseSrc(pm.storage,'./data/bgimage/');var ruleImageSrc=parseSrc(pm.rule,'./data/image/bg_rule_image/');if(pm.color){nextImageSrc='color:'+parseColor(pm.color)}var time=parseInt(pm.time);enableSkip=(pm.clickskip==='true');isWait=(pm.wait==='true');isReverse=(pm.reverse==='true');if(isSkip()&&enableShortCut){time=0}beginTransition(getPrevImageSrc(),nextImageSrc,ruleImageSrc,time)}};var master_tag=TYRANO.kag.ftag.master_tag;for(var tag_name in tag){master_tag[tag_name]=object(tag[tag_name]);master_tag[tag_name].kag=TYRANO.kag}var requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){return window.setTimeout(callback,1000/60)};var cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||function(timerId){clearTimeout(timerId)};var SCREEN_WIDTH=parseInt(TYRANO.kag.config.scWidth);var SCREEN_HEIGHT=parseInt(TYRANO.kag.config.scHeight);var renderTimerId=null;var prevImage=null;var nextImage=null;var ruleImage=null;var currentRule=null;var currentAlpha=null;var cacheRule={};var passedTime=null;var prevTime=null;var transTime=null;var transFrame=0;var transSpeed=1;var isTrans=false;var enableSkip=true;var isWait=true;var isReverse=false;var enableShortCut=(TYRANO.kag.stat.mp.shortcut!=='false');var oldNextOrder=TYRANO.kag.ftag.nextOrder;TYRANO.kag.ftag.nextOrder=function(){if(isTrans&&isWait){return false}oldNextOrder.apply(this,arguments)};var oldLoadGameData=TYRANO.kag.menu.loadGameData;TYRANO.kag.menu.loadGameData=function(){if(isTrans){isWait=false;finishTransition()}oldLoadGameData.apply(this,arguments)};var mainCanvas=createCanvas(SCREEN_WIDTH,SCREEN_HEIGHT);mainCanvas.id='canvas_bg_rule';mainCanvas.style.position='absolute';mainCanvas.style.zIndex='1';appendCanvas(mainCanvas);addEventListener(mainCanvas);function createCanvas(width,height){var canvasElement=document.createElement('canvas');canvasElement.width=width;canvasElement.height=height;canvasElement.ctx=canvasElement.getContext('2d');return canvasElement}function appendCanvas(canvasElement){$('#tyrano_base').find('.base_fore').eq(0).append(canvasElement)}function addEventListener(canvasElement){TYRANO.kag.layer.layer_event.on('click.bg_rule',function(){if(isTrans&&isWait&&enableSkip){skipTransition()}})}function beginTransition(prevImageSrc,nextImageSrc,ruleImageSrc,_transTime){transFrame=0;transSpeed=1;currentAlpha=0;passedTime=0;prevTime=getTime();transTime=_transTime;var loader=new ImageLoader(0,3,function(){loader.onload=null;if(transTime>0){TYRANO.kag.layer.showEventLayer();currentRule=getRule(ruleImageSrc);startRender()}else{finishTransition()}if(!isWait){TYRANO.kag.ftag.nextOrder()}});prevImage=loader.load(prevImageSrc);nextImage=loader.load(nextImageSrc);ruleImage=loader.load(ruleImageSrc)}function getTime(){return new Date().getTime()}function getRule(ruleImageSrc){if(typeof cacheRule[ruleImageSrc]==='undefined'){cacheRule[ruleImageSrc]=new Rule(ruleImage,SCREEN_WIDTH,SCREEN_HEIGHT)}return cacheRule[ruleImageSrc]}function getPrevImageSrc(){var base=document.getElementsByClassName("base_fore")[0];var url=base.style.backgroundImage;var ret;if(url!=='none'&&url!==''){var iUseMark=0;var startMarks=['\"','\'','('];var endMarks=['\"','\'',')'];for(var i=0;i<3;i++){if(url.indexOf(startMarks[i])>-1){iUseMark=i;break}}var a=url.indexOf(startMarks[iUseMark]);var b=url.lastIndexOf(endMarks[iUseMark]);ret=url.substr(a+1,b-a-1)}else{ret='color:'+base.style.backgroundColor}return ret}function ImageLoader(count,needCount,onload){this.count=count;this.needCount=needCount;this.onload=onload;return this}ImageLoader.prototype.load=function(imageSrc){var that=this;if(imageSrc.indexOf('color:')===0){that.needCount--;if(that.count===that.needCount){setTimeout(function(){if(typeof that.onload==='function'){that.onload()}},1)}return imageSrc.substr(6)}var imageElement=document.createElement('img');imageElement.onload=function(e){that.count++;if(that.count===that.needCount){if(typeof that.onload==='function'){that.onload()}}};imageElement.onerror=function(){TYRANO.kag.error('\n画像ファイル「'+imageSrc+'」を探しましたが、見つかりませんでした。')};imageElement.src=imageSrc;return imageElement};function startRender(){prevTime=getTime();isTrans=true;render()}function render(){transFrame++;cancelAnimationFrame(renderTimerId);renderTimerId=requestAnimationFrame(render);var now=getTime();var dif=now-prevTime;dif=dif*transSpeed;passedTime+=dif;prevTime=now;currentAlpha=passedTime/transTime;mainCanvas.ctx.save();drawImageOrColor(mainCanvas.ctx,prevImage,SCREEN_WIDTH,SCREEN_HEIGHT);currentRule.applyRule(mainCanvas.ctx,currentAlpha);mainCanvas.ctx.globalCompositeOperation='destination-over';drawImageOrColor(mainCanvas.ctx,nextImage,SCREEN_WIDTH,SCREEN_HEIGHT);mainCanvas.ctx.restore();if(transFrame===1){changeBaseLayer(nextImage)}if(currentAlpha>1){finishTransition()}}function finishTransition(){isTrans=false;cancelAnimationFrame(renderTimerId);changeBaseLayer(nextImage);mainCanvas.ctx.clearRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);if(isWait){TYRANO.kag.ftag.nextOrder()}}function changeBaseLayer(nextImage){var base=document.getElementsByClassName("base_fore")[0];if(typeof nextImage!=='string'){base.style.backgroundColor="rgba(0, 0, 0, 0)";base.style.backgroundImage="url("+nextImage.src+")"}else{base.style.backgroundImage="none";base.style.backgroundColor=nextImage}}function skipTransition(){if(isTrans){finishTransition()}}function drawImageOrColor(ctx,imageOrColor,width,height){if(typeof imageOrColor!=='string'){ctx.drawImage(imageOrColor,0,0,width,height)}else{ctx.fillStyle=imageOrColor;ctx.fillRect(0,0,width,height)}}function isSkip(){return TYRANO.kag.stat.is_skip===true||TYRANO.kag.stat.is_nowait===true}function parseSrc(src,base){if(src.substr(0,4)==='http'){return src}else{return base+src}}function parseColor(color){if(color.indexOf("0x")!=-1){return color.replace("0x","#")}return color}function Rule(imageElement,width,height){this.imageElement=imageElement;this.width=width;this.height=height;this.tempCanvas1=createCanvas(width,height);this.tempCanvas2=createCanvas(width,height);this.alphaCanvas1=createCanvas(width,height);this.alphaCanvas2=createCanvas(width,height);this.alphaCanvas1.ctx.drawImage(imageElement,0,0,width,height);var imagedata=this.alphaCanvas1.ctx.getImageData(0,0,width,height);var size=SCREEN_WIDTH*SCREEN_HEIGHT*4;for(var i=0;i<size;i+=4){imagedata.data[i+3]=imagedata.data[i]}this.alphaCanvas1.ctx.putImageData(imagedata,0,0);this.alphaCanvas2.ctx.fillStyle='#000000';this.alphaCanvas2.ctx.globalCompositeOperation='xor';this.alphaCanvas2.ctx.fillRect(0,0,width,height);this.alphaCanvas2.ctx.drawImage(this.alphaCanvas1,0,0,width,height)}Rule.prototype.applyRule=function(ctx,ratio){ctx.save();ctx.globalCompositeOperation='xor';ctx.drawImage(this.makeRule(ratio),0,0);ctx.restore();return ctx};Rule.prototype.makeRule=function(ratio){var c1=this.tempCanvas1.ctx;var c2=this.tempCanvas2.ctx;var a1=this.alphaCanvas1;var a2=this.alphaCanvas2;if(isReverse){a1=this.alphaCanvas2;a2=this.alphaCanvas1}var a;this.tempCanvas1.width=this.tempCanvas1.width;this.tempCanvas2.width=this.tempCanvas2.width;if(ratio<=0.5){a=1-ratio*2;c2.drawImage(a1,0,0);c2.globalCompositeOperation='lighter';c2.fillStyle='rgba(0, 0, 0,'+a+')';c2.fillRect(0,0,this.width,this.height);c1.fillStyle='#000000';c1.fillRect(0,0,this.width,this.height);c1.globalCompositeOperation='xor';c1.drawImage(this.tempCanvas2,0,0,this.width,this.height)}else{a=(ratio-0.5).toFixed(5)*2;c1.drawImage(a2,0,0,this.width,this.height);c1.globalCompositeOperation='lighter';c1.fillStyle='rgba(0, 0, 0,'+a+')';c1.fillRect(0,0,this.width,this.height)}return this.tempCanvas1}}(window.jQuery,window.TYRANO,window.object));